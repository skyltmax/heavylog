name: Publish release

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write # required for GitHub Packages publishing
  id-token: write # required for trusted publishing

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify:
    name: Verify versions match tag
    runs-on: ubuntu-latest
    if: ${{ !github.event.release.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract versions
        id: versions
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          # Allow tags like v1.2.3 or 1.2.3
          TAG_NO_V=${TAG#v}
          echo "tag=${TAG_NO_V}" >> "$GITHUB_OUTPUT"

          # version.rb version
          GEM_VER=$(sed -n 's/^[[:space:]]*VERSION[[:space:]]*=[[:space:]]*"\(.*\)"[[:space:]]*$/\1/p' lib/heavylog/version.rb)
          echo "gem=${GEM_VER}" >> "$GITHUB_OUTPUT"

          echo "Tag:        $TAG_NO_V"
          echo "RubyGems:   $GEM_VER"

          if [[ "$GEM_VER" != "$TAG_NO_V" ]]; then
            echo "Version mismatch: tag=$TAG_NO_V, gem=$GEM_VER" >&2
            exit 1
          fi
  verify_prerelease:
    name: Verify prerelease versions match tag
    runs-on: ubuntu-latest
    if: github.event.release.prerelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract and verify versions
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          TAG_NO_V=${TAG#v}

          # Ensure the tag contains a prerelease identifier (e.g. 0.0.13-beta.1)
          if [[ ! "$TAG_NO_V" =~ ^[0-9]+\.[0-9]+\.[0-9]+-.+ ]]; then
            echo "Tag '$TAG_NO_V' does not look like a valid prerelease version" >&2
            exit 1
          fi

          BASE_VERSION=${TAG_NO_V%%-*}
          GEM_VER=$(sed -n 's/^[[:space:]]*VERSION[[:space:]]*=[[:space:]]*"\(.*\)"[[:space:]]*$/\1/p' lib/heavylog/version.rb)

          echo "Tag:          $TAG_NO_V"
          echo "Base version: $BASE_VERSION"
          echo "RubyGems:     $GEM_VER"

          if [[ "$GEM_VER" != "$BASE_VERSION" ]]; then
            echo "Version mismatch: tag base=$BASE_VERSION, gem=$GEM_VER" >&2
            exit 1
          fi
  publish_gem:
    name: Publish Ruby gem
    needs: verify
    if: ${{ !github.event.release.prerelease }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          ruby-version: "3.4"
      - name: Build gem package
        run: |
          rm -f heavylog-*.gem
          gem build heavylog.gemspec
      - name: Configure trusted publishing credentials
        uses: rubygems/configure-rubygems-credentials@v1.0.0
      - name: Publish gem
        run: |
          GEM_FILE=$(ls -t heavylog-*.gem 2>/dev/null | head -n 1 || true)
          if [ -z "$GEM_FILE" ]; then
            echo "Gem file not found" >&2
            exit 1
          fi

          gem push "$GEM_FILE"
  publish_gem_prerelease:
    name: Publish prerelease gem
    needs: verify_prerelease
    if: github.event.release.prerelease
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: false
          ruby-version: "3.4"
      - name: Install dependencies
        run: bundle install
      - name: Set prerelease version from tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          # Ruby gem versions use dots instead of hyphens (e.g. 0.0.12.beta.1)
          GEM_VERSION="${TAG_VERSION//-/.}"

          echo "Setting prerelease version: $GEM_VERSION"
          sed -i "s/VERSION = \".*\"/VERSION = \"${GEM_VERSION}\"/" lib/heavylog/version.rb
          cat lib/heavylog/version.rb
      - name: Update Gemfile.lock
        run: bundle install
      - name: Build prerelease gem package
        run: |
          rm -f heavylog-*.gem
          gem build heavylog.gemspec
      - name: Configure trusted publishing credentials
        uses: rubygems/configure-rubygems-credentials@v1.0.0
      - name: Publish prerelease gem
        run: |
          GEM_FILE=$(ls -t heavylog-*.gem 2>/dev/null | head -n 1 || true)
          if [ -z "$GEM_FILE" ]; then
            echo "Gem file not found" >&2
            exit 1
          fi

          gem push "$GEM_FILE"
